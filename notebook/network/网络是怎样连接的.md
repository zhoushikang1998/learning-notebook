## 1.探索浏览器内部

- 应用程序并不是自己去控制网络，而是委托操作系统来控制网络。

- 主要步骤

  > 输入 URL ---> 解析网址 ---> 根据网址的含义生成请求消息
  >
  > ---> 向 DNS 服务器查询 Web 服务器的 IP 地址
  >
  > ---> 全世界上万台 DNS 服务器共同查询 IP 地址
  >
  > ---> 委托协议栈（操作系统）发送消息

### 1.1 生成 HTTP 请求消息

- http/ftp...：访问方式

- url 解析：域名+文件路径 ===> 确定 Web 服务器和文件名

- / 结尾：访问默认文件名（如 index.html）

  ```bash
  # 如果 Web 服务器上存在名为 whatisthis 的文件，则将 whatisthis 作为文件名来处理；如果存在名为 whatisthis 的目录，则将 whatisthis 作为目录名来处理
  http://www.lab.glasscom.com/whatisthis
  ```

- HTTP  的基础思路

  - 对什么：URI（访问目标）
  - 进行怎样的操作：方法（HTTP 谓语、动词）
  - 表示附加信息的头字段
  - 状态码：表示操作的执行结果是成功还是发生了错误

- 1 条请求消息中只能写 1 个 URI。如果需要获取多个文件，必须对每个文件单独发送 1 条请求。

  > 判断所需的文件，然后获取这些文件并显示在屏幕上，这一系列工作的整体指挥也是浏览器的任务之一，而 Web 服务器却毫不知情。Web 服务器完全不关心这 4 条请求获取的文件到底是1个网页上的还是不同网页上的，它的任务就是对每一条单独的请求返回 1 条响应而已。



### 1.2 向 DNS 服务器查询 Web 服务器的 ip 地址

- 子网：通过集线器连接起来的所有设备都属于同一个子网

- 网络：将子网通过路由器连接起来，就形成了一个网络

  > 消息 ===》 子网中的集线器 ===》路由器 ===》 下一个路由器 ===》目标子网 ===》 目的地

- IP地址的主机号

  - 全 0：表示整个子网
  - 全 1：表示向子网上所有设备发送包，即“广播”

- DNS（Domain Name System，域名服务系统）：通过名称查询 IP 地址，通过 IP 地址查询名称

  - 域名解析：查询 IP 地址的操作
  - 根据域名查询IP地址时，浏览器会使用 Socket 库中的解析器。
  - **需要设置 DNS 服务器 IP 地址**

- Socket 库是用于**调用网络功能的程序组件集合**。

- 客户端的查询消息包含以下 3 种信息。

  - 域名

    > www 开头知识最早设计 Web 的时候默认的命名，形成的一个惯例，不是 World Wide Web。

  - Class（IN）

  - 记录类型（A、MX、PTR......）

- DNS 服务器会从**域名与 IP 地址的对照表**中查找相应的记录，并返回 IP 地址。

- 域名的层次结构

  - 对于公司分配的域名（可以通过创建下级域(子域)，将他们分配给各个事业集团）
  - 可以从根域开始一路往下顺藤摸瓜找到任意一个域的 DNS 服务器。
  - 还需要完成另一项工作：将根域的 DNS 服务器信息**保存在互联网中所有的 DNS 服务器中**。

- 找到目标 DNS 服务器

  <img src="images/找到目标DNS服务器.jfif" style="zoom:50%;" />

- 在真实的互联网中，**一台 DNS 服务器可以管理多个域的信息**。



### 1.3 委托协议栈发送消息

- 向操作系统内部的协议栈发出委托时，需要按照指定的顺序来调用 Socket 库中的程序组件。

- TCP、套接字、Channel

- 建立管道的过程

  - 创建套接字（创建套接字阶段）====》IP + Port

  - 将管道连接到服务器端的套接字上（连接阶段）

  - 收发数据（通信阶段）

  - 断开管道并删除套接字（断开阶段）

    ```bash
    # Socket库方法
    # 应用程序通过“描述符”这一类似号码牌的东西来识别套接字
    socket
    # 需要指定描述符、服务器 IP 地址和端口号这 3 个参数
    connect 
    # 指定描述符和发送数据
    write
    # 需要指定用于存放接收到的响应消息的内存地址(接收缓冲区)
    read
    # 连接在套接字之间的管道会被断开，套接字本身也会被删除。
    close
    ```

    

- 同一台计算机上可能同时存在多个套接字，使用**描述符**识别某个特定的套接字。

- **描述符**是用来在一台计算机内部识别套接字的机制，**端口号**就是用来让通信的另一方能够识别出套接字的机制

- 描述符：应用程序用来识别套接字的机制

- IP地址和端口号：客户端和服务器之间用来识别对方套接字的机制



## 2.探索协议栈和网卡



### 2.1 协议栈

- 浏览器、邮件等一般应用程序收发数据时用 TCP；DNS 查询等收发较短的控制数据时用 UDP。
- **ICMP** 用于告知网络包传送过程中**产生的错误以及各种控制消息**，ARP 用于根据 IP 地址**查询相应的以太网 MAC 地址**。
- 创建套接字
  - 套接字的实体就是通信控制信息。
  - 创建套接字时，首先分配一个套接字所需的内存空间，然后向其中写入初始状态。

- 连接
  - 连接实际上是通信双方交换控制信息，在套接字中记录这些必要信息并准备数据收发的一连串操作**（建立 TCP 连接）**
    - 连接操作的第一步是在 TCP 模块处创建表示连接控制信息的头部。
    - 通过 TCP 头部中的发送方和接收方端口号可以找到要连接的套接字。
  - 通信操作中使用的控制信息分为两类。（1）头部中记录的信息（2）套接字（协议栈中的内存空间）中记录的信息

- 收发数据

  - 发送数据到协议栈，协议栈收到数据后，**将数据存放在内部的发送缓冲区**中

    - MTU：每个网络包能容纳的数据长度，以太网中一般为 1500 字节。
    - MSS：除去头部之后，一个网络包所能容纳的 TCP 数据的最大长度。
    - 计时器：当经过一定时间之后，就会把网络包发送出去

  - 应用程序的数据一般都比较大，因此 TCP 会按照网络包的大小**对数据进行拆分**。

  - 使用 **ACK 号**确认网络包已收到。

  - 数据双向传输：**通过“序号”和“ACK 号”可以确认接收方是否收到了网络包。**

    <img src="images/数据双向传输.jfif" style="zoom:67%;" />

  - 通过这一机制，我们可以确认接收方有没有收到某个包，如果没有收到则重新发送，这样一来，无论网络中发生任何错误，我们都可以发现并采取补救措施（重传网络包）。

  - **网卡、集线器、路由器都没有错误补偿机制**，一旦检测到错误就直接丢弃相应的包。

  - TCP 采用了**动态调整等待时间的方法**，这个等待时间是根据 ACK 号返回所需的时间来判断

    > TCP 会在发送数据的过程中持续测量 ACK 号的返回时间，如果 ACK 号返回变慢，则相应延长等待时间；相对地，如果 ACK 号马上就能返回，则相应缩短等待时间

  - **使用 滑动窗口管理 ACK 号**

    > 接收方需要告诉发送方自己最多能接收多少数据，然后发送方根据这个值对数据发送操作进行控制，这就是滑动窗口方式的基本思路。

  - 将 ACK 号和更新窗口大小合并成一个包发送。

  - 接收 HTTP 响应消息

    - 协议栈会将接收到的数据**复制到应用程序指定的内存地址中（接收缓冲区）**，然后将控制流程交回应用程序。将数据交给应用程序之后，协议栈还需要找到合适的时机向发送方发送窗口更新（将 ACK 好和更新窗口大小合并）。

- 从服务器断开并删除套接字

  - 断开连接过程
    - 客户端发送 FIN
    - 服务器返回 ACK 号
    - 服务器发送 FIN
    - 客户端返回 ACK 号
  - 一般来说会等待几分钟之后再删除套接字。（防止误删除）

### 2.2 TCP 整体流程

![](images/TCP整体流程.jfif)



### 2.3 IP 与以太网的包收发操作

- 网络包结构

  <img src="images/网络包结构.jfif" style="zoom:67%;" />

- 路由器根据目标地址判断下一个路由器的位置

  - IP 协议根据**目标地址**判断下一个 IP 转发设备的位置

- 集线器在子网中将网络包传输到下一个路由

  - 子网中的以太网协议将包传输到下一个转发设备

- **IP 头部地址为目的地服务器并保持不变；Mac 头部在路由器转发包时将地址改写为下一个路由器（R2）**。

- IP 头部中包含 IP 协议规定的、根据 IP 地址**将包发往目的地所需的控制信息**；MAC 头部包含通过以太网的局域网**将包传输至最近的路由器所需的控制信息。**

- 以太网的部分也可以替换成其他的东西，例如无**线局域网、ADSL、FTTH** 等，它们都可以替代以太网的角色帮助 IP  协议来传输网络包。将 IP 和负责传输的网络分开，可以更好地根据需要使用各种通信技术。

- 封装好的包会被交给网络硬件，统称为**网卡**。

  - 传递给网卡的网络包是由一连串 0 和 1 组成的数字信息，**网卡会将这些数字信息转换为电信号或光信号**，并通过网线（或光纤）发送出去，然后这些信号就会到达集线器、路由器等转发设备，再由转发设备一步一步地送达接收方。
  - 无论要收发的包是控制包还是数据包，IP 对各种类型的包的收发操作都是相同的。
  - IP 地址实际上并不是分配给计算机的，而是分配给网卡的，因此当计算机上存在多块网卡时，每一块网卡都会有自己的IP地址。
  - 根据**路由表**判断应该把包交给哪块网卡。（发送发 IP 地址）
  - IP 模块根据**路由表** Gateway 栏的内容判断应该把包发送给谁。
  - **通过 ARP 查询目标路由器的 MAC 地址**
    - 利用广播对所有设备提问，然后对应 ip 会回复 mac 地址。
    - 将查询结果放到 ARP 缓存中。
  - 网卡的 ROM 中保存着全世界唯一的 MAC 地址，这是在生产网卡时写入的。
  - 网卡中保存的 MAC 地址会由网卡驱动程序读取并分配给 MAC 模块。
  - 网卡的 MAC 模块生成通用信号，然后由 PHY（MAU）模块转换成可在网线中传输的格式，并通过网线发送出去。

- 以太网

  - 与接收者地址匹配的设备就接收这个包，其他的设备则丢弃这个包，这样我们的包就送到指定的目的地了。
  - 通过交换机：现在信号只会流到根据 MAC 地址指定的设备，而不会到达其他设备

- 通知计算机的操作会使用一个叫作**中断的机制**。

  - 计算机没有一直监控网卡的活动，网卡驱动也是计算机中运行的一个程序，不知道包到达的状态，这时需要中断机制打断计算机正在执行的任务，让计算机注意到网卡发生的事情。

  - 工作过程

    > 网卡向扩展总线中的中断信号线发送信号，该信号线通过计算机中的中断控制器连接到 CPU。当产生中断信号时，CPU 会暂时挂起正在处理的任务，切换到操作系统中的中断处理程序。然后，中断处理程序会调用网卡驱动，控制网卡执行相应的接收操作。



## 3.探索集线器、交换机和路由器



### 3.1 集线器（传输信号）

- 所有的包在传输到目的地的过程中都是独立的，相互之间没有任何关联。
- 防止网线中的信号衰减很重要——双绞”是为了抑制噪声
  - 通过两根信号线的缠绕抵消**外源性噪声**；
  - 通过改变节距抑制**内源性噪声**（串扰）。
- 当信号到达集线器后，会被广播到整个网络中。
- 网卡不仅可以连接集线器，因为网卡的 PHY（MAU）模块和集线器都是一样的，所以**两台计算机的网卡也可以相互连接**，只要将一侧的发送信号线和另一侧的接收信号线连起来就可以收发数据了。
- 接收信号的设备（交换机、路由器、服务器等），会在将信号转换成数字信息后通过 FCS 校验发现错误，并将出错的包丢弃。丢弃包并不会影响数据的传输，因为丢弃的包不会触发确认响应。因此**协议栈的 TCP 模块会检测到丢包，并对该包进行重传。**



### 3.2 交换机（包转发操作）

- 交换机的设计是将网络包原样转发到目的地。

- 交换机的一个端口就相当于计算机上的一块网卡。交换机的端口不具有 MAC 地址。

  > 网卡本身具有 MAC 地址，并通过核对收到的包的接收方 MAC 地址判断是不是发给自己的，**如果不是发给自己的则丢弃**；
  >
  > 
  >
  > 交换机的端口不核对接收方 MAC 地址，而是直接接收所有的包并存放到缓冲区中。

- 信号 ---》 网线接口 ---》 PHY（MAU）模块接收 ---》将网线中的信号转换为通用格式，传递给 **MAC 模块** ---》将信号转换为数字信息（FCS检验错误）---》存放到**缓冲区**中 ---》查询这个包的接收方 MAC 地址是否在 **MAC 地址表**中 ---》 通过**交换电路**将包发送到相应的端口

- MAC 地址表：

  - MAC 地址
  - 交换机端口
  - 交换机会**自行更新或删除地址表**中的记录。当地址表的内容出现异常时，只要重启一下交换机就可以重置地址表，也不需要手动进行维护。

- **交换电路**：

  - 每个交叉点上的交换开关都可以独立工作，因此只要路径不重复，就**可以同时传输多路信号**。

    <img src="images/交换电路设计.jfif" style="zoom:50%;" />

- 特殊情况

  - 当交换机发现一个包要发回到原端口时，就会直接丢弃这个包。
  - 地址表中找不到指定的 MAC 地址。交换机无法判断应该把包转发到哪个端口，只能将包转发到除了源端口之外的所有端口上，无论该设备连接在哪个端口上都能收到这个包。
  - 如果接收方 MAC 地址是一个广播地址，那么交换机会将包发送到除源端口之外的所有端口。

- 全双工模式是交换机特有的工作模式，它可以同时进行发送和接收操作，集线器不具备这样的特性。

  - 在全双工模式下，无需等待其他信号结束就可以发送信号，因此它比半双工模式速度要快

- **自动协商：确定最优的传输速率**

  - 通过特定排列的脉冲信号将自己能够支持的**工作模式**和**传输速率**相互告知对方，并从中选择一个最优的组合。

- 交换机可同时执行多个转发操作。集线器会将输入的信号广播到所有的端口，如果同时输入多个信号就会发生碰撞，无法同时传输多路信号，因此**从设备整体的转发能力来看，交换机要高于集线器。**

### 3.3 路由器（包转发操作）

- 路由器包括转发模块和端口模块。
  - 转发模块负责判断包的转发目的地。
  - 端口模块负责包的收发操作。
- 转发包：通过端口接收发过来的包 ---》转发模块根据包的 IP 头部记录的接收方 IP 地址，在路由表中查询，判断转发目标 ---》将包转移到转发目标对应的端口 ---》 端口按照硬件的规则将包发送出去
- 路由器的各个端口都具有 MAC 地址和 IP 地址。
- 路由表中的信息
  - 路由器根据“IP 地址”判断转发目标。	
  - 路由器会忽略主机号，**只匹配网络号。**
  - **路由聚合**：经过路由聚合，多个子网会被合并成一个子网，子网掩码会发生变化，同时，目标地址列也会改成聚合后的地址。
  - 路由表的子网掩码列**只表示在匹配网络包目标地址时需要对比的比特数量**。
  - 路由表记录维护
    - 由人手动维护路由记录
    - 根据路由协议机制，通过路由器之间的信息交换由路由器自行维护路由表的记录
- 路由器的包接收操作：
  - 路由器的端口都具有 MAC 地址，**只接收与自身地址匹配的包**，遇到不匹配的包则直接丢弃。
  - 通过路由器转发的网络包，其接收方 MAC 地址为路由器端口的 MAC 地址。
    - 查询路由表判断转发目标：根据包的接收方 IP 地址**查询路由表**中的目标地址栏，以找到相匹配的记录 ---》多个候选转发目标 ---》**网络号比特数最长的记录（最长匹配原则）**---》**选择跃点计数较小的记录** ---》在路由表中无法找到匹配的记录，路由器会丢弃这个包，并通过 ICMP 消息告知发送方
    - 找不到匹配路由时选择默认路由。路由表中子网掩码为 `0.0.0.0` 的记录表示“**默认路由**”。
  - 更新 IP 头部中的 TTL：发送方在发送包时会将 TTL 设为 64 或 128，没经过一个路由器的转发，就会减 1，变为 0 时表示超过了有效期，丢弃包。
  - 包的长度超过 MTU 时，可以使用 IP 协议中定义的分片功能对包进行拆分，缩短每个包的长度。
- 包发送操作：
  - 路由器判断下一个转发目标的方法如下。
    - 如果路由表的**网关列内容为 IP 地址**，则该地址就是下一个转发目标。
    - 如果路由表的网关列内容为空，则 **IP 头部中的接收方 IP 地址**就是下一个转发目标。
  - 路由器也会使用 ARP 来查询下一个转发目标的 MAC 地址。



### 3.4 路由器的附加功能

- **地址转换**：内网中的设备不能和互联网直接收发网络包，而是通过一种特别的机制进行连接，这个机制就叫地址转换。

  - 基本原理：在转发网络包时**对 IP 头部中的 IP 地址和端口号进行改写。**

    <img src="images/利用端口号改写IP.jfif" style="zoom:67%;" />

  - 在对外只能使用一个公有地址的情况下，可以**用不同的端口号来区别内网中的不同终端**。

  - 改写端口号的原因：用公有地址加上端口的组合对应一个私有地址，一个公有地址就可以对应几万个私有地址，这种方法**提高了公有地址的利用率**。

  - 用于外网访问的服务器：可以放在地址转换设备的外面并为它**分配一个公有地址**，也可以**将服务器的私有地址手动添加到地址转换设备中**，这样就可以从互联网访问到这台具有私有地址的服务器了。（这种配置中，需要将地址转换设备的共有地址添加到 DNS 服务器中）

- 包过滤：在对包进行转发时，根据 **MAC 头部、IP 头部、TCP 头部、ICMP **的内容，按照事先设置好的规则**决定是转发这个包，还是丢弃这个包。**

### 3.5 交换机和路由器的异同

- 相同点
  - 网络包经过集线器和交换机之后，到达了路由器，并在此被转发到下一个路由器。工作原理同交换机类似，通过查表判断包转发的目标。
- 不同点
  - **路由器是基于 IP 设计的，而交换机是基于以太网设计的。**
  - 交换机中**对 MAC 地址表的维护**是包转发操作中的一个步骤，而**路由器中对路由表的维护是与包转发操作相互独立**的，也就是说，在转发包的过程中不需要对路由表的内容进行维护。
- 关系
  - 路由器将包的传输工作委托给交换机来进行（将 IP 包装进以太网包的数据部分）
  - IP（路由器）负责将包送达通信对象这一整体过程，而其中将包传输到下一个路由器的过程则是由以太网（交换机）来负责的。







## 4.探索接入网和网络运营商

### 4.1 ADSL 接入网的结构和工作方式

- **距离的不同和路由的维护方式**，是互联网与家庭、公司网络之间最主要的两个不同点。

- 互联网接入路由器会在网络包前面加上 **MAC 头部、PPPoE 头部、PPP 头部**总共 3 种头部，然后发送给ADSL Modem （PPPoE方式下）。

- ADSL Modem将包拆分成信元，并转换成电信号发送给分离器。

- ADSL使用**正交振幅调制**表示比特数。

- 分离器的功能：将一定频率以上的信号过滤掉，即过滤掉 ADSL 使用的高频信号。只有电话信号才会传入电话机，但对于另一头的 ADSL Modem，则是传输原本的混合信号给它。

- 多条信号线捆绑在一起形成电话电缆。电话局附近的地下电缆很多，集中埋设电缆的地方就形成了一条地道，这部分称为**电缆隧道**。

- **DSLAM** 具有 ATM 接口，和后方路由器收发数据时使用的是**原始网络包拆分后的 ATM 信元形式**。

- **BAS** 负责将 ATM 信元还原成网络包并转发到互联网内部。

  <img src="images/网络包从用户到互联网的传输过程.jfif" style="zoom:80%;" />

### 4.2 接入网中使用的 PPP 和隧道

- PPP：Point-to-Point Protocol，点对点协议
- PPPoE 是**将 PPP 消息装入以太网包**进行传输的方式。
- PPPoA 方式不添加 MAC 头部和 PPPoE 头部，而是直接将包装入信元中。
- DHCP 方式：不使用 PPP，而是将以太网包直接转换成 ADSL 信号发送给 DSLAM。
- **隧道**：将包含头部在内的整个包从隧道的一头扔进去，这个包就会原封不动地从隧道的另一头出来。
  - 实现方式：
    1. **基于 TCP 连接**：在网络上的两台隧道路由器之间建立 TCP 连接，然后将连接两端的套接字当作是路由器的端口，并从这个端口来收发数据。
    2. **基于封装**：将包含头部在内的整个包装入另一个包中传输到隧道的另一端。
- BAS（Broadband Access Server，宽带接入服务器）：类似于路由器。
- 接入网的整体工作流程
  - 互联网接入路由器通过 PPPoE 的发现机制**查询 BAS 的 MAC 地址**。
  - BAS 下发的 TCP/IP 参数会被配置到互联网接入路由器的 BAS 端的端口上，这样路由器就完成接入互联网的准备了。
  - BAS 在收到用户路由器发送的网络包之后，会**去掉 MAC 头部和 PPPoE 头部**，然后用**隧道机制**将包发送给网络运营商的路由器。
- 一对一连接的端口可以不分配 IP 地址，这种方式称为**无编号**。



### 4.3 网络运营商内部

- POP：Point of Presense，接入点。
  - POP 中包括各种类型的路由器，路由器的基本工作方式是相同的，但根据其角色分成了不同的类型。

<img src="images/互联网内部.jfif" style="zoom:67%;" />

- 网络包通过接入网之后，到达运营商 POP 的路由器。
- NOC：Network Operation Center，网络运行中心。
  - 从 POP 传来的网络包都会集中到这里，并从这里被转发到离目的地更近的 POP，或者是转发到其他的运营商。
  - 可以认为，NOC 就是规模扩大后的 POP。



### 4.4 跨越运营商的网络包

- 到达 POP 路由器之后，网络包的传输
  - 对于互联网内部的路由器来说，无论最终目的地是否属于同一家运营商，**都可以从路由表中查到**，因此只要一次接一次按照路由表中的目标地址来转发包，最终一定可以到达 Web 服务器所在的 POP。
- 运营商之间的路由信息交换
  - 让相连的路由器告知路由信息。
  - 通过 **BGP**（Border Gateway Protocol，边界网关协议） 机制自动完成路由信息交换（运营商之间）。
  - 路由交换方式：
    - 转接：将互联网中的路由全部告知对方
    - 对等：仅将与各自网络相关的路由信息告知对方
  - IX（Internet eXchange，互联网交换中心）：通过连接到中心设备的方式来减少线路数量
    - IX 的核心是具有大量高速以太网端口的二层交换机。可以认为 IX 的核心就是大型的、高速的交换机。





## 5.服务器端的局域网



### 5.1 防火墙的结构和原理

- 防火墙方式：
  - 包过滤（常用）
  - 应用层网关
  - 电路层网关
- 包过滤
  - TCP
    - 通过**接收方 IP 地址、发送方 IP 地址、接收方端口号、发送方端口号、TCP 控制位（SYN、ACK）**这些条件，我们可以判断出通信的起点和终点、应用程序种类，以及访问的方向，最终决定是否允许某个包通过。
  - UDP：不能通过控制为判断。要么冒一定的风险允许该应用程序的所有包通过，要么牺牲一定的便利性阻止该应用程序的所有包通过。——使用其他方式的防火墙。
  - 地址转换功能：互联网和公司内网之间相互传输。
- 防火墙无法抵御的攻击
  - 假设 Web 服务器在收到含有特定数据的包时会引起宕机。防火墙只关心包的起点和终点，因此即便包中含有特定数据，防火墙也无法发现，于是包就被放行了。然后，当包到达 Web 服务器时，就会引发服务器宕机。
    - 修复 Web 服务器程序的 Bug，以防止宕机。
  - 在防火墙之外部署用来检查包的内容并阻止有害包的设备或软件。



### 5.2 负载均衡

- 使用多台服务器来分担负载的架构，统称为**分布式架构**。
- 轮询：通过 DNS 服务器，将访问平均分配给所有的服务器。
  - 缺点：假如有一台出现故障，不能检查到 Web 服务器宕机了，仍然返回这台服务器的 IP 地址。
- 使用负载均衡器分配访问
  - 用负载均衡器的 IP 地址代替 Web 服务器的实际地址注册到 DNS 服务器上（**认为负载均衡器就是一台 Web 服务器**）
  - 向负载均衡器发送请求，由负载均衡器来判断将请求转发给哪台 Web 服务器。
  - 当操作跨多个页面时，则不考虑 Web 服务器的负载，而是**必须将请求发送到同一台 Web 服务器上**。（通过 Cookie 或其他技术判断一个操作是否跨了多个页面）



### 5.3 缓存服务器

- 缓存服务器：通过代理机制对数据进行缓存的服务器。
- 缓存服务器通过更新时间管理内容
  - 缓存服务器和负载均衡器一样，需要代替 Web 服务器被注册到 DNS 服务器中。
- 正向代理
  - 代理在转发过程中可以查看请求的内容，所以可以根据内容判断是否允许访问。通过代理可以禁止员工访问危险的网站，或者是与工作内容无关的网站
- 反向代理
- 透明代理：查看请求消息的包头部，包的 IP 头部包含接收方的 IP 地址，通过这个地址，就知道用户要访问的服务器。



### 5.4 内容分发服务

- 缓存服务器部署在客户端（流量减少，Web 服务器的运营者无法控制）
- 缓存服务器部署在 Web 服务器端（流量不变）
- 内容分发服务：CDN，提供 CDN 服务的厂商 （CDSP）
- 如何找到最近的缓存服务器？
  - 不采用轮询方式，而是判断客户端与缓存服务器之间的距离，并返回距离客户端最近的缓存服务器IP地址
  - 需要事先从缓存服务器部署地点的路由器收集路由信息
  - **DNS 服务器根据路由表查询从本机到 DNS 查询消息的发送方**，也就是客户端 DNS 服务器的路由信息。
- 通过**重定向**服务器分配访问目标
  - 使用重定向告知客户端最近的缓存服务器
  - 将重定向服务器注册到 Web 服务器端的 DNS 服务器上
  - 缺点：增加了 HTTP 消息的交互次数，开销较大。
  - 优点：重定向的方法是根据客户端发送来的 HTTP 消息的发送方 IP 地址来估算距离的，因此**精度较高**。



## 6.服务器



### 6.1 服务器程序的通信操作

- 服务器端的具体工作过程。

  ```bash
  # 创建套接字
  socket()
  # 进入等待连接状态
  # 将端口号写入套接字中
  bind()
  # 向套接字写入等待连接状态这一控制信息
  listen()
  # 接受连接，有一个套接字持续等待连接（创建套接字的新副本，并让客户端连接到这个新副本上）
  accept()
  # 接收数据
  read
  # 发送数据
  write
  # 断开连接
  close
  ```

  

<img src="images/服务器程序的通信操作.jfif" style="zoom:67%;" />

- 协议栈采用了创建套接字的新副本，并让客户端连接到这个新副本上的方法，**保证有一个套接字在等待连接**。
- 新创建的套接字副本必须和原来的等待连接的套接字具有相同的端口号。
- 解决无法判断包时哪个套接字的问题：
  - 通过**客户端 IP 地址、客户端端口号、服务器 IP 地址、服务器端口号**进行判断
  - 有了上述四种信息，为什么还要用**描述符**？
    - 等待连接的套接字中没有客户端IP地址和端口号
    - 使用描述符这一种信息比较简单



### 6.2 服务器的接收操作

- MAC 模块：
  - 网卡的 MAC 模块将网络包从信号还原为数字信息，校验 FCS 并存入缓冲区。
  - 网卡驱动会根据 MAC 头部判断协议类型，并将包交给相应的协议栈。
- IP 模块：协议栈的IP模块会检查IP头部，（1）判断是不是发给自己的；（2）判断网络包是否经过分片；（3）将包转交给 TCP 模块或 UDP 模块。
- TCP 模块：
  - 如果收到的是发起连接的包，则 TCP 模块会：（1）确认 TCP 头部的控制位 SYN;（2）检查接收方端口号；（3）为相应的等待连接套接字复制一个新的副本；（4）记录发送方 IP 地址和端口号等信息。
  - 收到数据包时，TCP模块会：（1）根据收到的包的发送方 IP 地址、发送方端口号、接收方 IP 地址、接收方端口号找到相对应的套接字；（2）将数据块拼合起来并保存在接收缓冲区中；（3）向客户端返回 ACK。
- TCP 模块的断开操作（同客户端）：当断开操作完成后，套接字会在经过一段时间后被删除。



### 6.3 Web 服务器程序解释请求消息并作出响应



- CGI 程序
  - Web 服务器会检查 URI 指定的文件名，看一看这个文件是不是一个程序（.cgi、.php 等）。
  - 如果判断要访问的文件为程序文件，Web 服务器会委托操作系统运行这个程序，然后从请求消息中取出数据并交给运行的程序。
  - 运行的程序收到数据后会进行一系列处理，并将输出的数据返回给 Web 服务器。
- Web 服务器的访问控制
  - 访问控制规则（主要有 3 种）
    - 客户端 IP 地址
      - 在调用 accept 接受连接时，就知道了客户端的 IP 地址，检查其是否允许访问。
    - 客户端域名
      - 根据客户端域名设置规则时，需要先根据客户端 IP 地址查询客户端域名，这需要使用 DNS服务器。
    - 用户名和密码
      - Web 服务器查看接收到的用户名和密码与事先设置好的用户名和密码是否一致，以此判断是否允许访问





## #附录 网络包的旅程



<img src="images/网络包的旅程1.jfif" style="zoom:100%;" />

<img src="images/网络包的旅程2.jfif" style="zoom:100%;" />