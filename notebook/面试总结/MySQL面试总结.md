## 1.MVCC



## 2.InnoDB

​	

### 锁机制与 InnoDB 锁算法



## 3.一条 SQL 语句执行过程

- MySQL 主要分为 Server 层和引擎层，Server 层主要包括连接器、查询缓存、分析器、优化器、执行器，同时还有一个日志模块（binlog），这个日志模块所有执行引擎都可以共用,redolog 只有 InnoDB 有。
- 引擎层是插件式的，目前主要包括，MyISAM,InnoDB,Memory 等。
- SQL 等执行过程分为两类，一类对于查询等过程如下：权限校验---》分析器---》优化器---》执行器---》调用引擎的接口---》返回接口执行结果
- -   redolog 两阶段提交 ===》保证数据的一致性
    - 先写 redolog 直接提交：写完 redolog 后机器挂了，binlog 没有写入，机器重启后会通过 redolog 恢复数据，但是 binlog 没有记录该数据，那么机器备份和主从同步时会丢失这一条数据。
    - 先写 binlog：写完 binlog 后机器异常重启，由于没有 redolog，机器无法恢复这条记录，但是 binlog 有记录，导致数据不一致。



## 4.一条 SQL 执行很慢的原因

### 大部分情况正常，偶尔出现执行很慢的情况

- 数据库在刷新脏页（flush）

  - redolog 写满了：redolog 的容量有限，被写满后，只能暂停其他操作，将数据同步到磁盘中；导致 sql 语句突然执行很慢。
  - 内存不够用：一次查询较多数据，查询的数据页不再内存中时，要申请内存。此时恰好内存不足需要淘汰一部分内存数据页，干净页直接释放，脏页则需要刷新页。
  - MySQL 任务系统“空闲”的时候。
  - MySQL 正常关闭的时候：MySQL 会把内存的脏页都 flush 到磁盘上，这样下次 MySQL 启动的时候，就可以直接从磁盘上读数据，启动速度会很快。

- 拿不到锁：等待锁释放

  ```mysql
  # 查看当前进程状态
  show processlist;
  ```

### 一直执行很慢

- 没用到索引

  - 字段没有索引
  - 字段有索引，没有使用到索引（索引失效）

- 数据库选错索引

  > 主键索引和非主键索引是有区别的，主键索引存放的值是**整行字段的数据**，而非主键索引上存放的值不是整行字段的数据，而且存放**主键字段的值**。
  >
  >  
  >
  > 如果走 c 这个字段的索引的话，最后会查询到对应主键的值，然后，再根据主键的值走主键索引，查询到整行数据返回。

  - 系统有可能走全表索引而不走索引。
    - 系统通过**索引的区分度(基数：索引上不同的值越多，区分度越高)**
    - 系统通过采样的方式，来预测索引的基础
    - **由于统计的失误，导致系统没有走索引，而是走了全表扫描**
  - 可以使用 force index 强制走索引的方式



## 5.binlog





## 6.MySQL 性能调优



## 7.索引优化

1. 索引分析
2. 索引失效

## 常用命令：

```mysql
# 查看进程列表状态
show processlist;

# 
```



## 基准测试工具

- sysbench
- mysqlslap
- Jmeter

